(function (factory) {
    if (typeof define === 'function' && define.amd) {
        define(['jquery', 'datatables.net', 'datatables.net-buttons'], function ($) {
            return factory($, window, document);
        });
    } else if (typeof exports === 'object') {
        module.exports = function ($, window, document, undefined) {
            if (!$.fn.dataTable) {
                require('datatables.net')($, window, document);
            }
            if (!$.fn.dataTable.Buttons) {
                require('datatables.net-buttons')($, window, document);
            }
            return factory($, window, document, undefined);
        };
    } else {
        factory(jQuery, window, document);
    }
})(function ($, window, document, undefined) {
    var DataTable = $.fn.dataTable;

    DataTable.ext.buttons.print = {
        className: 'buttons-print',
        text: function (dt) {
            return dt.i18n('buttons.print', 'Escala PDF');
        },
        action: function (e, dt, button, config) {
            var data = dt.buttons.exportData(config.exportOptions);

            var createTable = function (data, type) {
                var table = '<table style="border-collapse: collapse; width: 100%; border: 1px solid black; font-size: 14px;">'; // Estilos de borda para a tabela e tamanho de fonte
                var colWidths = []; // Array para armazenar larguras das colunas

                if (type === 'header' && data.header) {
                    table += '<thead>'; // Cor de fundo preta para o cabeçalho
                    table += '<tr>';

                    // Calcular larguras das colunas do cabeçalho com base no conteúdo
                    for (var i = 0, ien = data.header.length; i < ien; i++) {
                        var cellContent = data.header[i];
                        var cellWidth = getTextWidth(cellContent) + 20; // Adicionar espaço extra para padding
                        colWidths.push(cellWidth);

                        table += '<th style="border: 1px solid black; padding: 8px; width: ' + (i < 2 ? '45%' : '10%') + ';">' + cellContent + '</th>'; // Estilos para as células do cabeçalho
                    }

                    table += '</tr>';
                    table += '</thead>';
                }

                if (type === 'body') {
                    table += '<tbody>';

                    // Usar as larguras definidas para as colunas do corpo da tabela
                    for (var i = 0, ien = data.body.length; i < ien; i++) {
                        table += '<tr>';
                        for (var j = 0, jen = data.body[i].length; j < jen; j++) {
                            var cellContent = data.body[i][j];
                            table += '<td style="border: 1px solid black; padding: 8px; width: ' + colWidths[j] + 'px;">' + cellContent + '</td>'; // Estilos para as células do corpo da tabela com larguras definidas
                        }
                        table += '</tr>';
                    }

                    table += '</tbody>';
                }

                if (type === 'footer' && data.footer) {
                    table += '<tfoot>';
                    table += '<tr>';

                    // Usar as larguras definidas para as colunas do rodapé
                    for (var i = 0, ien = data.footer.length; i < ien; i++) {
                        var cellContent = data.footer[i];
                        table += '<th style="border: 1px solid black; padding: 8px; width: ' + (i < 2 ? '45%' : '10%') + ';">' + cellContent + '</th>'; // Estilos para as células do rodapé com larguras definidas
                    }

                    table += '</tr>';
                    table += '</tfoot>';
                }

                table += '</table>';
                return table;
            };

            var title = config.title;
            if (typeof title === 'function') {
                title = title(dt);
            }
            if (title.indexOf('*') !== -1) {
                title = title.replace('*', $('title').text());
            }

            var popup = window.open('', '');
            popup.document.close();

            var fixedText = '<h2 style="color: #333; font-family: Arial, sans-serif;">Escala de Serviço</h2>';

            var headContent = '<title>' + title + '</title>';
            $('style, link').each(function () {
                var node = this.cloneNode(true);
                if (node.nodeName.toLowerCase() === 'link') {
                    var href = new URL(node.href);
                    if (href.host.indexOf('/') === -1 && href.pathname.indexOf('/') !== 0) {
                        href.host += '/';
                    }
                    headContent += node.outerHTML;
                }
            });

            try {
                popup.document.head.innerHTML = headContent;
            } catch (err) {
                $(popup.document.head).html(headContent);
            }

            var bodyContent = '<h1>' + title + '</h1><p>' + fixedText + '</p>' + createTable(data, 'header') + createTable(data, 'body');
            popup.document.body.innerHTML = bodyContent;

            // Adicionar a imagem como marca d'água no documento de impressão
            var watermarkImageUrl = '/images/logo/pmpe_logo.png'; // Substitua pelo caminho da sua imagem de marca d'água
            var watermarkStyle = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1000; opacity: 0.1; pointer-events: none;'; // Estilo para posicionar a marca d'água

            var watermarkElement = popup.document.createElement('img');
            watermarkElement.setAttribute('src', watermarkImageUrl);
            watermarkElement.setAttribute('style', watermarkStyle);
            popup.document.body.appendChild(watermarkElement);

            if (config.customize) {
                config.customize(popup);
            }

            setTimeout(function () {
                if (config.autoPrint) {
                    popup.print();
                    popup.close();
                }
            }, 250);

            // Função para obter largura do texto (aproximadamente)
            function getTextWidth(text) {
                var canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
                var context = canvas.getContext("2d");
                context.font = "14px Arial"; // Defina a fonte e o tamanho aqui
                var metrics = context.measureText(text);
                return metrics.width + 16; // Adicione algum espaço extra para o padding e bordas
            }
        },

        title: '*',
        message: '',
        exportOptions: {},
        header: true,
        footer: false,
        autoPrint: true,
        customize: null
    };

    return DataTable.Buttons;
});
